# sa01h-48g-v04-web å‡çº§åŠŸèƒ½è¯¦ç»†åˆ†æ

## 1. ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

å‡çº§ç³»ç»Ÿé‡‡ç”¨äº†Webå‰ç«¯ + Qtåå°çš„æ¶æ„ï¼š

- **Webå‰ç«¯**: `ph1-sw41hh-u22-web` é¡¹ç›®ä¸­çš„ `systemsetting.vue`
- **Qtåå°**: `sa01h-48g-v04-web` é¡¹ç›®ä½œä¸ºåå°æœåŠ¡ç¨‹åº
- **é€šä¿¡åè®®**: WebSocket (ç«¯å£8081)

```
Webå‰ç«¯ (Vue.js)  â†â†’  WebSocket  â†â†’  Qtåå°ç¨‹åº (QML/C++)
    â†“                                      â†“
systemsetting.vue                 sa01h-48g-v04-web
```

## 2. å‡çº§åŒ…ç»“æ„

å‡çº§åŒ…ä¸º `update.zip`ï¼Œè§£å‹ååŒ…å«ä»¥ä¸‹å­åŒ…ï¼š

```
update/
â”œâ”€â”€ C51.zip     # C51å•ç‰‡æœºå›ºä»¶
â”œâ”€â”€ fpga.zip    # FPGAå›ºä»¶ 
â”œâ”€â”€ mcu.zip     # ä¸»æ§MCUå›ºä»¶
â”œâ”€â”€ sg.zip      # ç³»ç»Ÿè½¯ä»¶åŒ…
â”œâ”€â”€ spi.zip     # SPIçƒ§å½•å·¥å…·
â””â”€â”€ www.zip     # Webåº”ç”¨åŒ…
```

## 3. WebSocketé€šä¿¡æœºåˆ¶è¯¦è§£

### 3.1 æœåŠ¡å™¨ç«¯å®ç° (Qtåå°)

Qtåå°ç¨‹åºå¯åŠ¨WebSocketæœåŠ¡å™¨(main.qml)ï¼š

```qml
WebSocketServer {
    id: webSocketServer
    port: 8081
    Component.onCompleted: {
        webSocketServer.startServer();
    }
}
```

**WebSocketè¿æ¥å»ºç«‹å’ŒåŒºåˆ†æœºåˆ¶**ï¼š

å½“å®¢æˆ·ç«¯è¿æ¥åˆ°WebSocketæœåŠ¡å™¨æ—¶ï¼Œåå°é€šè¿‡URLè·¯å¾„æ¥åŒºåˆ†è¿æ¥ç±»å‹ï¼š

```cpp
// websocketserver.cpp - onNewConnectionå‡½æ•°
void WebSocketServer::onNewConnection()
{
    QWebSocket *pSocket = m_pWebSocketServer->nextPendingConnection();
    QString path = pSocket->requestUrl().path();  // è·å–è¯·æ±‚è·¯å¾„
    qDebug() << "New client connected to path:" << path;

    // æ ¹æ®è·¯å¾„åˆ†é…åˆ°ä¸åŒçš„å®¢æˆ·ç«¯åˆ—è¡¨
    if (path == "/ws/upload") {
        m_uploadClients << pSocket;  // å‡çº§ä¸“ç”¨è¿æ¥åˆ—è¡¨
    } else if (path == "/ws/uart") {
        m_clients << pSocket;        // ä¸²å£é€šä¿¡è¿æ¥åˆ—è¡¨
    } else {
        qDebug() << "Unknown path, closing connection:" << path;
        pSocket->close();  // æœªçŸ¥è·¯å¾„ï¼Œå…³é—­è¿æ¥
        return;
    }
    
    // ç»‘å®šæ¶ˆæ¯å¤„ç†å‡½æ•°
    connect(pSocket, &QWebSocket::textMessageReceived, this, &WebSocketServer::processTextMessage);
    connect(pSocket, &QWebSocket::binaryMessageReceived, this, &WebSocketServer::processBinaryMessage);
}
```

æ”¯æŒä¸¤ç§è·¯å¾„çš„WebSocketè¿æ¥ï¼š
- `/ws/upload`: ç”¨äºå‡çº§æ–‡ä»¶ä¸Šä¼ å’Œå‡çº§æ§åˆ¶
- `/ws/uart`: ç”¨äºä¸²å£é€šä¿¡å’ŒçŠ¶æ€æŸ¥è¯¢

**æ¶ˆæ¯è·¯ç”±æœºåˆ¶**ï¼š
```cpp
// åœ¨æ¶ˆæ¯å¤„ç†æ—¶æ ¹æ®å‘é€è€…ç¡®å®šè·¯å¾„
QString path = m_uploadClients.contains(pSender) ? "/ws/upload" : "/ws/uart";
```

### 3.2 å®¢æˆ·ç«¯å®ç° (Webå‰ç«¯)

Webå‰ç«¯é€šè¿‡WebSocketè¿æ¥åˆ°Qtåå°ï¼š

```javascript
// systemsetting.vue - ws_upload_openå‡½æ•°
ws_upload_open() {
    let self = this;
    // è¿æ¥åˆ°å‡çº§ä¸“ç”¨è·¯å¾„
    this.socket = new WebSocket("ws://" + location.hostname + ":8081/ws/upload");
    
    this.socket.onmessage = function (event) {
        console.log("UPLOAD: " + event.data);
        self.data_split(event.data);  // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
    };
    
    this.socket.onopen = function (event) {
        console.log("uploadpath successfully connected");
    };
    
    // è‡ªåŠ¨é‡è¿æœºåˆ¶
    this.socket.onclose = function (event) {
        console.log("uploadpath connection closed");
        setTimeout(() => {
            self.ws_upload_open();  // 1ç§’åé‡è¿
        }, 1000);
    };
}
```

## 4. æ–‡ä»¶ä¸Šä¼ è¯¦ç»†æµç¨‹

### 4.1 æ–‡ä»¶æ¥æ”¶å’Œä¿å­˜è¿‡ç¨‹

**æ­¥éª¤1: ç”¨æˆ·é€‰æ‹©æ–‡ä»¶**
```javascript
// ç”¨æˆ·åœ¨Webç•Œé¢é€‰æ‹©update.zipæ–‡ä»¶ï¼Œè§¦å‘uploadFileså‡½æ•°
uploadFiles() {
    if (!this.checkFile()) {  // éªŒè¯æ–‡ä»¶æ ¼å¼
        this.DialogOTANotice = true;
        this.OTANoticeText = "Please select the correct firmware file!";
        return;
    }
    let name = this.files[0].name;
    if (name.endsWith(".zip")){
        this.uploadingFile = true;
        this.uploadingFileType = "ZIP";
        this.uploadFile(3);  // è°ƒç”¨ä¸Šä¼ å‡½æ•°ï¼Œå‚æ•°3è¡¨ç¤ºZIPç±»å‹
    }
}
```

**æ­¥éª¤2: åˆ†ç‰‡ä¸Šä¼ **
```javascript
// uploadFileå‡½æ•° - æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ 
uploadFile(upgradetype) {
    this.uploadingFile = true;
    var blob = this.files[0];  // è·å–æ–‡ä»¶å¯¹è±¡
    
    // å‘é€å¼€å§‹ä¸Šä¼ å‘½ä»¤ (cmd = 30 for ZIP)
    this.socket.send(JSON.stringify({
        cmd: upgradetype * 10,      // 3 * 10 = 30
        data: blob.name,            // æ–‡ä»¶å
    }));
    
    const BYTES_PER_CHUNK = 1024 * 1024 * 2;  // 2MBåˆ†ç‰‡å¤§å°
    const SIZE = blob.size;                    // æ–‡ä»¶æ€»å¤§å°
    
    var start = 0;
    var end = BYTES_PER_CHUNK;
    
    // å¾ªç¯å‘é€æ–‡ä»¶æ•°æ®å—
    while (start < SIZE) {
        var chunk = blob.slice(start, end);    // åˆ‡ç‰‡
        this.socket.send(chunk);               // å‘é€äºŒè¿›åˆ¶æ•°æ®
        start = end;
        end = start + BYTES_PER_CHUNK;
    }
    
    // å‘é€ç»“æŸå‘½ä»¤ (cmd = 31 for ZIP)
    this.socket.send(JSON.stringify({
        cmd: upgradetype * 10 + 1,  // 3 * 10 + 1 = 31
        data: blob.name,
    }));
}
```

**æ­¥éª¤3: Qtåå°æ–‡ä»¶æ¥æ”¶**
```cpp
// websocketserver.cpp - processTextMessageå‡½æ•°å¤„ç†æ§åˆ¶å‘½ä»¤
void WebSocketServer::processTextMessage(const QString &message) {
    QWebSocket *pSender = qobject_cast<QWebSocket *>(sender());
    QString path = m_uploadClients.contains(pSender) ? "/ws/upload" : "/ws/uart";
    if(path=="/ws/upload"){
        QJsonDocument doc = QJsonDocument::fromJson(message.toUtf8());
       if (doc.isNull()) {
           qDebug() << "Invalid JSON message";
           emit messageReceived(message,path);
           return;
       }

       QJsonObject json = doc.object();
       int cmd = json["cmd"].toInt();
       QString filename = json["data"].toString();


       if (cmd % 10 == 0) {
           m_terminalManager.executeCommand("mkdir /tmp/update");
           m_terminalManager.executeCommand("rm -rf /tmp/update/*");
           QString filePath = "/tmp/update/update.zip";
           QFile *file = new QFile(filePath);
           if (!file->open(QIODevice::WriteOnly)) {
               qDebug() << "Failed to open file for writing:" << filePath;
               delete file;
               return;
           }
           m_activeFileUploads[pSender] = file;
           qDebug() << "Start receiving file:" << filePath;

       } else if (cmd % 10 == 1) {
           if (m_activeFileUploads.contains(pSender)) {

               m_terminalManager.executeDetachedCommand("/data/upgrademodule");
               QFile *file = m_activeFileUploads.take(pSender);
//               file->close();
               QFileInfo fileInfo(*file);
               qint64 fileSize = fileInfo.size();
               qDebug() << "File upload completed:" << filename << "Size:" << fileSize << "bytes";
               delete file;
               m_terminalManager.executeCommand("unzip -o /tmp/update/update.zip -d /tmp/update");
               m_terminalManager.executeCommand("rm -rf /userdata/spi");
               m_terminalManager.executeCommand("mv /tmp/update/spi /userdata/spi");
               m_terminalManager.executeCommand("chmod +x /userdata/spi");

               QDir updateDir("/tmp/update");
               if (!updateDir.exists()) {
                   qDebug() << "Directory /tmp/update does not exist";
                   return;
               }
               QString filenum = "";
               QFileInfoList entries = updateDir.entryInfoList(QDir::NoDotAndDotDot | QDir::AllEntries);
               for (const QFileInfo &entry : entries) {
                   qDebug() << (entry.isDir() ? "[DIR] " : "[FILE]") << entry.fileName()
                            << "Size:" << entry.size() << "bytes";
                   filenum += entry.fileName()+" ";
               }
               sendMessageToUploadClients("File upload completed\r\n");
               sendMessageToUploadClients("upgradenum:"+filenum.trimmed()+"\r\n");

               if(cmd==31){
                   qDebug() << "start unzip:" << filename;
//                   connectToTcpServer("127.0.0.1", 35353);
//                    m_terminalManager.executeDetachedCommand("/userdata/update.sh");
               }
           }
       }
    }else {
        emit messageReceived(message,path);
    }

}

// processBinaryMessageå‡½æ•°å¤„ç†äºŒè¿›åˆ¶æ•°æ®
void WebSocketServer::processBinaryMessage(const QByteArray &message) {
    QWebSocket *pSender = qobject_cast<QWebSocket *>(sender());
    
    if (m_activeFileUploads.contains(pSender)) {
        QFile *file = m_activeFileUploads[pSender];
        qDebug() << "Writing to file:" << file->fileName() 
                 << "Size:" << message.size() << "bytes";
        file->write(message);    // å†™å…¥æ–‡ä»¶æ•°æ®
        file->flush();           // å¼ºåˆ¶åˆ·æ–°åˆ°ç£ç›˜
    }
}
```
```
root@rk3568-buildroot:/data# strings upgrademodule | head -n 20
/lib/ld-linux-aarch64.so.1
libQt5Network.so.5
_init
__gmon_start__
_fini
_ITM_deregisterTMCloneTable
_ITM_registerTMCloneTable
_ZN12QHostAddressD1Ev
_ZN10QTcpServerC1EP7QObject
_ZN10QTcpSocketC1EP7QObject
_ZN10QTcpServer6listenERK12QHostAddresst
_ZNK15QAbstractSocket5stateEv
_ZN15QAbstractSocket5abortEv
_ZNK12QHostAddress8toStringEv
_ZNK15QAbstractSocket11peerAddressEv
_ZN10QTcpServer5closeEv
_ZN12QHostAddressC1ENS_14SpecialAddressE
_ZNK15QAbstractSocket8peerPortEv
_ZNK10QTcpServer11errorStringEv
libQt5SerialPort.so.5
root@rk3568-buildroot:/data# 
```

### 4.2 è‡ªåŠ¨è§£å‹ç¼©å¤„ç†

**è§£å‹ç¼©ä½ç½®**: å½“æ–‡ä»¶ä¸Šä¼ å®Œæˆåï¼Œåœ¨Qtåå°çš„`processTextMessage`å‡½æ•°ä¸­è‡ªåŠ¨æ‰§è¡Œï¼š

```cpp
// cmd % 10 == 1 æ—¶æ‰§è¡Œ (ç»“æŸä¸Šä¼ å‘½ä»¤)
if (m_activeFileUploads.contains(pSender)) {
    QFile *file = m_activeFileUploads.take(pSender);
    QFileInfo fileInfo(*file);
    qint64 fileSize = fileInfo.size();
    qDebug() << "File upload completed:" << filename << "Size:" << fileSize << "bytes";
    delete file;
    
    // è‡ªåŠ¨è§£å‹ç¼©å‡çº§åŒ…
    m_terminalManager.executeCommand("unzip -o /tmp/update/update.zip -d /tmp/update");
    
    // å¤„ç†SPIå·¥å…·
    m_terminalManager.executeCommand("rm -rf /userdata/spi");
    m_terminalManager.executeCommand("mv /tmp/update/spi /userdata/spi");
    m_terminalManager.executeCommand("chmod +x /userdata/spi");
    
    // æ‰«æè§£å‹åçš„æ–‡ä»¶åˆ—è¡¨
    QDir updateDir("/tmp/update");
    QString filenum = "";
    QFileInfoList entries = updateDir.entryInfoList(QDir::NoDotAndDotDot | QDir::AllEntries);
    for (const QFileInfo &entry : entries) {
        qDebug() << (entry.isDir() ? "[DIR] " : "[FILE]") << entry.fileName();
        filenum += entry.fileName() + " ";
    }
    
    // é€šçŸ¥å‰ç«¯æ–‡ä»¶åˆ—è¡¨
    sendMessageToUploadClients("File upload completed\r\n");
    sendMessageToUploadClients("upgradenum:" + filenum.trimmed() + "\r\n");
}
```

## 5. å‡çº§æ‰§è¡Œæµç¨‹

### 5.1 å‡çº§æµç¨‹å›¾

ä»¥ä¸‹æ˜¯ä»é¡µé¢æ“ä½œåˆ°å‡çº§å®Œæˆçš„å®Œæ•´æµç¨‹ï¼š

```mermaid
graph TD
    A[ç”¨æˆ·ç‚¹å‡»é€‰æ‹©æ–‡ä»¶] --> B[é€‰æ‹©update.zipæ–‡ä»¶]
    B --> C[ç‚¹å‡»UploadæŒ‰é’®]
    C --> D[checkFileéªŒè¯æ–‡ä»¶æ ¼å¼]
    D --> E{æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®}
    E -->|å¦| F[æ˜¾ç¤ºé”™è¯¯æç¤º]
    E -->|æ˜¯| G[uploadFileså‡½æ•°]
    G --> H[è°ƒç”¨uploadFileå‡½æ•°]
    H --> I[å‘é€å¼€å§‹å‘½ä»¤JSON]
    I --> J[æ–‡ä»¶åˆ†ç‰‡2MB]
    J --> K[å¾ªç¯å‘é€äºŒè¿›åˆ¶æ•°æ®å—]
    K --> L[å‘é€ç»“æŸå‘½ä»¤JSON]
    L --> M[Qtåå°æ¥æ”¶æ•°æ®]
    M --> N[åˆ›å»º/tmp/updateç›®å½•]
    N --> O[ä¿å­˜ä¸ºupdate.zip]
    O --> P[è‡ªåŠ¨è§£å‹åˆ°/tmp/update]
    P --> Q[ç§»åŠ¨spiå·¥å…·åˆ°/userdata]
    Q --> R[å‘é€upgradenumæ¶ˆæ¯]
    R --> S[æ˜¾ç¤ºå¯å‡çº§ç»„ä»¶åˆ—è¡¨]
    S --> T[ç”¨æˆ·ç‚¹å‡»Upgrade]
    T --> U[upgradeå‡½æ•°å‘é€å‡çº§å‘½ä»¤]
    U --> V[Qtåå°æ¥æ”¶å‡çº§æŒ‡ä»¤]
    V --> W{å‡çº§ç»„ä»¶ç±»å‹}
    W -->|MCU| X[upgrademcuå‡½æ•°]
    W -->|C51| Y[upgradec51å‡½æ•°]
    W -->|FPGA| Z[upgradefpgaå‡½æ•°]
    W -->|RK3568| AA[upgraderk3568å‡½æ•°]
    X --> BB[è§£å‹mcu.zipåˆ°/data]
    X --> CC[è¿æ¥TCPæœåŠ¡å™¨35353ç«¯å£]
    Y --> DD[GPIO106æ§åˆ¶]
    Y --> EE[è§£å‹c51.zipåˆ°/data]
    Y --> FF[ä¸²å£å‘é€ISPå‘½ä»¤]
    Z --> GG[GPIO144æ§åˆ¶]
    Z --> HH[è§£å‹fpga.zipåˆ°/data]
    Z --> II[SPIçƒ§å½•FPGA]
    AA --> JJ[æ‰§è¡Œupdate.shè„šæœ¬]
    BB --> KK[å‡çº§å®Œæˆ]
    FF --> LL[å‡çº§å®Œæˆ]
    II --> MM[å‡çº§å®Œæˆ]
    JJ --> NN[å‡çº§å®Œæˆ]
```

### 5.2 å‡çº§æ‰§è¡Œé˜¶æ®µ

å‡çº§æŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š`mcu â†’ c51 â†’ fpga â†’ rk3568`

```javascript
// Webå‰ç«¯ - upgradeå‡½æ•°
upgrade() {
    this.log_show_flag = true;     // æ˜¾ç¤ºæ—¥å¿—çª—å£
    this.processs_flag = true;     // æ˜¾ç¤ºè¿›åº¦æ¡
    this.upbtn_enable_flag = false; // ç¦ç”¨ä¸Šä¼ æŒ‰é’®
    
    var str = "upgrade:";
    if(this.upgrade_mcu) str += "mcu,";
    if(this.upgrade_c51) str += "c51,";
    if(this.upgrade_fpga) str += "fpga,";
    if(this.upgrade_rk3568) str += "rk3568";
    
    this.socket.send(str + "\r\n");  // å‘é€å‡çº§å‘½ä»¤åˆ°Qtåå°
}
```

## 6. å…³é”®å‡½æ•°åŠŸèƒ½è¯¦è§£

### 6.1 webSocketServer.sendMessageToAllClientsåŠŸèƒ½

```qml
// main.qmlä¸­çš„åŠŸèƒ½è¯´æ˜
// å‘æ‰€æœ‰è¿æ¥åˆ°/ws/uartè·¯å¾„çš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
function sendMessageToAllClients(message) {
    // éå†æ‰€æœ‰ä¸²å£é€šä¿¡å®¢æˆ·ç«¯
    for (QWebSocket *pClient : qAsConst(m_clients)) {
        if (pClient && pClient->isValid()) {
            pClient->sendTextMessage(message);  // å‘é€æ–‡æœ¬æ¶ˆæ¯
        }
    }
}

// ç”¨é€”ï¼š
// 1. å‘é€å‡çº§æ—¥å¿—: "UPGRADELOG||start upgrade mcu...\r\n"
// 2. å‘é€è¿›åº¦ä¿¡æ¯: "PROGRESSVALUE||50\r\n" 
// 3. å‘é€çŠ¶æ€å“åº”: "RESPONSE||F858||1,V1.0\r\n"
```

### 6.2 webSocketServer.sendMessageToUploadClientsåŠŸèƒ½

```cpp
// websocketserver.cpp
void WebSocketServer::sendMessageToUploadClients(const QString &message) {
    // å‘æ‰€æœ‰è¿æ¥åˆ°/ws/uploadè·¯å¾„çš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
    for (QWebSocket *client : qAsConst(m_uploadClients)) {
        if (client && client->isValid()) {
            client->sendTextMessage(message);
        }
    }
}

// ç”¨é€”ï¼š
// 1. æ–‡ä»¶ä¸Šä¼ å®Œæˆé€šçŸ¥: "File upload completed\r\n"
// 2. å‡çº§åŒ…å†…å®¹åˆ—è¡¨: "upgradenum:mcu.zip c51.zip fpga.zip\r\n"
// 3. IPé…ç½®å“åº”: "host ip 192.168.1.100\r\n"
```

### 6.3 terminalManager.executeCommandåŠŸèƒ½

```qml
// TerminalManageræ˜¯Qtåå°çš„ç»ˆç«¯å‘½ä»¤æ‰§è¡Œç»„ä»¶
// åŠŸèƒ½ï¼šåŒæ­¥æ‰§è¡ŒLinuxç³»ç»Ÿå‘½ä»¤å¹¶ç­‰å¾…ç»“æœ

terminalManager.executeCommand("mkdir /tmp/update");
// ä½œç”¨ï¼šåˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºå­˜æ”¾å‡çº§æ–‡ä»¶

terminalManager.executeCommand("rm -rf /tmp/update/*");
// ä½œç”¨ï¼šæ¸…ç©ºä¸´æ—¶ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶

terminalManager.executeCommand("unzip -o /tmp/update/update.zip -d /tmp/update");
// ä½œç”¨ï¼šè§£å‹å‡çº§åŒ…åˆ°æŒ‡å®šç›®å½•
// -o: è¦†ç›–å·²å­˜åœ¨æ–‡ä»¶
// -d: æŒ‡å®šè§£å‹ç›®æ ‡ç›®å½•
```

### 6.4 webSocketServer.connectToTcpServeråŠŸèƒ½

```cpp
// websocketserver.cpp
void WebSocketServer::connectToTcpServer(const QString &host, quint16 port) {
    m_tcpClient->connectToServer(host, port);
}

// ä¸ºä»€ä¹ˆè¦è¿æ¥TCPæœåŠ¡å™¨(ç«¯å£35353)ï¼Ÿ
// 1. MCUå‡çº§éœ€è¦é€šè¿‡ä¸“é—¨çš„å›ºä»¶å‡çº§æœåŠ¡
// 2. è¯¥æœåŠ¡è¿è¡Œåœ¨localhost:35353ç«¯å£
// 3. Qtåå°ä½œä¸ºä¸­ä»‹ï¼Œå°†å‡çº§å‘½ä»¤è½¬å‘ç»™å›ºä»¶å‡çº§æœåŠ¡
// 4. å›ºä»¶å‡çº§æœåŠ¡è´Ÿè´£å…·ä½“çš„MCUå›ºä»¶çƒ§å½•è¿‡ç¨‹
```

## 7. Linuxå‘½ä»¤è¯¦è§£

### 7.1 GPIOæ§åˆ¶å‘½ä»¤

```bash
# C51å‡çº§GPIOæ§åˆ¶å‘½ä»¤è¯¦è§£
"echo 106 > /sys/class/gpio/export"
# ä½œç”¨ï¼šå¯¼å‡ºGPIO106å¼•è„šï¼Œä½¿å…¶å¯ä»¥è¢«ç”¨æˆ·ç©ºé—´ç¨‹åºæ§åˆ¶(å‘Šè¯‰ Linuxï¼šâ€œæˆ‘è¦ä½¿ç”¨ GPIO106â€,è¿™ä¼šåœ¨ /sys/class/gpio/gpio106/ ä¸‹ç”Ÿæˆæ§åˆ¶æ–‡ä»¶å¤¹ï¼Œç”¨æˆ·ç©ºé—´å°±èƒ½æ“ä½œè¿™ä¸ª GPIO å¼•è„š)
# GPIO106å¯¹åº”AF2å¼•è„šï¼Œç”¨äºæ§åˆ¶C51å‡çº§æ¨¡å¼
# èƒŒæ™¯ï¼šLinux å†…æ ¸é»˜è®¤æŠŠ GPIO è®¾å¤‡éƒ½å±è”½æ‰ï¼Œåªæœ‰ä½ â€œå¯¼å‡ºâ€åæ‰å¯æ§

"echo out > /sys/class/gpio/gpio106/direction"  
# ä½œç”¨ï¼šè®¾ç½®GPIO106ä¸ºè¾“å‡ºæ¨¡å¼
# directionæ–‡ä»¶æ§åˆ¶å¼•è„šçš„è¾“å…¥/è¾“å‡ºæ–¹å‘
# èƒŒæ™¯ï¼š å¦‚æœä½ æƒ³ç”¨å®ƒâ€œæ§åˆ¶â€åˆ«çš„èŠ¯ç‰‡ï¼ˆæ¯”å¦‚ C51ï¼‰ï¼Œå°±è¦è¾“å‡ºç”µå¹³ï¼ˆä¸æ˜¯è¯»å–ï¼‰ï¼Œæ‰€ä»¥è¿™æ­¥æ˜¯å¿…è¦çš„åˆå§‹åŒ–

"echo 0 > /sys/class/gpio/gpio106/value"
# ä½œç”¨ï¼šè®¾ç½®GPIO106è¾“å‡ºä½ç”µå¹³(0V)ï¼Œè®© C51 å¼•è„šè¿›å…¥â€œä½ç”µå¹³ç­‰å¾…çŠ¶æ€â€
# å°†C51ç½®äºå‡†å¤‡å‡çº§çŠ¶æ€

"echo 1 > /sys/class/gpio/gpio106/value"
# ä½œç”¨ï¼šè®¾ç½®GPIO106è¾“å‡ºé«˜ç”µå¹³(3.3V) ï¼Œç›¸å½“äºåˆ¶é€ äº†ä¸€ä¸ªâ€œä¸Šå‡æ²¿â€ä¿¡å·
# è§¦å‘C51è¿›å…¥å‡çº§æ¨¡å¼ï¼ˆä¸Šå‡æ²¿è§¦å‘ï¼‰
# å¾ˆå¤šå•ç‰‡æœºï¼ˆæ¯”å¦‚ STC ç³»åˆ—ï¼‰é€šè¿‡æŸä¸ª GPIO å¼•è„šçš„â€œä¸Šå‡æ²¿â€åˆ¤æ–­æ˜¯å¦è¿›å…¥ ISP/å‡çº§æ¨¡å¼
# æ‰€ä»¥ä½ å¿…é¡»å…ˆ 0 â†’ ç„¶åå† 1ï¼Œæ¨¡æ‹Ÿè¿™ä¸ªè·³å˜



# ä¸ºä»€ä¹ˆè¦ç”¨ echo å†™æ–‡ä»¶ï¼Ÿ	Linux çš„ sysfs æ˜¯â€œç”¨æ–‡ä»¶æ¨¡æ‹Ÿç¡¬ä»¶æ¥å£â€ï¼Œå†™æ–‡ä»¶å°±æ˜¯å†™å¯„å­˜å™¨
# ä¸ºä»€ä¹ˆ GPIO è¦å…ˆ exportï¼Ÿ	Linux å‡ºäºå®‰å…¨ä¸æ•ˆç‡è€ƒè™‘ï¼Œä¸é»˜è®¤æš´éœ²æ‰€æœ‰ GPIO
# ä¸ºä»€ä¹ˆå…ˆ 0 å 1ï¼Ÿ	å› ä¸º C51 æ˜¯é€šè¿‡ä¸Šå‡æ²¿è¯†åˆ«â€œå‡çº§æ¨¡å¼â€çš„è§¦å‘æ¡ä»¶
# å¦‚æœé‡å¤æ“ä½œå‘¢ï¼Ÿ	å¤šæ¬¡ export ä¼šæŠ¥é”™ï¼Œå¯å…ˆ unexportï¼›é‡å¤æ‹‰ä½å†æ‹‰é«˜æ˜¯æ— å®³çš„
```

### 7.2 æ–‡ä»¶æ“ä½œå‘½ä»¤

```bash
"rm -rf /data/c51.hex"
# ä½œç”¨ï¼šåˆ é™¤æ—§çš„C51å›ºä»¶æ–‡ä»¶
# -r: é€’å½’åˆ é™¤
# -f: å¼ºåˆ¶åˆ é™¤ï¼Œä¸è¯¢é—®

"unzip -o /tmp/update/c51.zip -d /data/"
# ä½œç”¨ï¼šè§£å‹C51å›ºä»¶åŒ…åˆ°/dataç›®å½•
# -o: è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶
# -d: æŒ‡å®šè§£å‹ç›®æ ‡ç›®å½•
```

### 7.3 ä¸²å£é€šä¿¡å‘½ä»¤

```javascript
serialPortManager.writeDataUart6("ISP 51 2\r\n", 1);
// ä½œç”¨ï¼šå‘ä¸²å£6å‘é€ISPå‘½ä»¤
// "ISP 51 2": å¯åŠ¨C51 ISP(In-System Programming)æ¨¡å¼
// ISP: åœ¨ç³»ç»Ÿç¼–ç¨‹ï¼Œå…è®¸é€šè¿‡ä¸²å£æ›´æ–°å›ºä»¶
// å‚æ•°2: å¯èƒ½è¡¨ç¤ºå‡çº§æ¨¡å¼ç±»å‹æˆ–æ³¢ç‰¹ç‡è®¾ç½®
// \r\n: å›è½¦æ¢è¡Œç¬¦ï¼Œå‘½ä»¤ç»“æŸæ ‡å¿—
```

## 8. FPGAå‡çº§è¯¦ç»†è¯´æ˜

### 8.1 upgradefpgaå‡½æ•°è¯¦è§£

```qml
// main.qml - upgradefpgaå‡½æ•°
function upgradefpga(){
    // GPIOæ§åˆ¶ - è¿›å…¥FPGAå‡çº§æ¨¡å¼
    
    // 1. æ§åˆ¶U3å¼•è„š(GPIO144)
    terminalManager.executeCommand("echo 144 > /sys/class/gpio/export");
    // å¯¼å‡ºGPIO144ï¼Œå¯¹åº”ç¡¬ä»¶å¼•è„šU3
    
    terminalManager.executeCommand("echo out > /sys/class/gpio/gpio144/direction");
    // è®¾ç½®ä¸ºè¾“å‡ºæ¨¡å¼
    
    terminalManager.executeCommand("echo 1 > /sys/class/gpio/gpio144/value");
    // è®¾ç½®é«˜ç”µå¹³ - æ³¨æ„ï¼šè¿™ä¸æ–‡æ¡£è¦æ±‚ä¸ç¬¦ï¼
    // æ–‡æ¡£è¦æ±‚U3åº”è¯¥è®¾ä¸ºLOWï¼Œä½†ä»£ç è®¾ä¸ºHIGH
    
    // 2. æ§åˆ¶GPIO42 (å¯èƒ½æ˜¯å…¶ä»–æ§åˆ¶å¼•è„š)
    terminalManager.executeCommand("echo 42 > /sys/class/gpio/export");
    terminalManager.executeCommand("echo out > /sys/class/gpio/gpio42/direction");
    // åªæ˜¯å¯¼å‡ºå’Œè®¾ç½®æ–¹å‘ï¼Œæ²¡æœ‰è®¾ç½®ç”µå¹³å€¼
    
    // 3. å›ºä»¶æ–‡ä»¶å¤„ç†
    terminalManager.executeCommand("rm -rf /data/top.bin");
    // åˆ é™¤æ—§çš„FPGAå›ºä»¶æ–‡ä»¶
    
    terminalManager.executeCommand("unzip -o /tmp/update/fpga.zip -d /data/");
    // è§£å‹FPGAå›ºä»¶åŒ…ï¼Œè·å–top.binæ–‡ä»¶
    
    webSocketServer.sendMessageToAllClients("UPGRADELOG||start upgrade FPGA...\r\n");
    // é€šçŸ¥å‰ç«¯å¼€å§‹FPGAå‡çº§
    
    // 4. SPIçƒ§å½•FPGA
    terminalManager.executeCommand("/userdata/spi -w -f /data/top.bin -a 0000");
    // ä½¿ç”¨SPIå·¥å…·çƒ§å½•FPGAå›ºä»¶
    // -w: å†™å…¥æ¨¡å¼
    // -f: æŒ‡å®šå›ºä»¶æ–‡ä»¶è·¯å¾„
    // -a 0000: èµ·å§‹åœ°å€ä¸º0x0000
}
```

### 8.2 GPIOå¼•è„šå¯¹åº”å…³ç³»æ¥æº

**GPIOç¼–å·å’Œå¼•è„šçš„å¯¹åº”å…³ç³»**æ¥æºäº`GPIO_FPGA_Control_README.md`æ–‡æ¡£ï¼š

```markdown
| ç‰©ç†å¼•è„š | GPIOå®šä¹‰    | ç†è®ºè®¡ç®—å€¼ | å®é™…ä½¿ç”¨GPIO | æµ‹è¯•çŠ¶æ€ |
|---------|-------------|------------|-------------|---------|
| A21     | GPIO0_C4_d  | 20         | **16**      | âœ… é€šè¿‡  |
| U3      | GPIO4_C0_d  | 144        | **144**     | âœ… é€šè¿‡  |
| AF2     | GPIO3_B2_d  | 106        | **106**     | âœ… é€šè¿‡  |

GPIOç¼–å·è®¡ç®—æ–¹æ³•ï¼š
- GPIOç»„åŸºæ•°ï¼šGPIOx = x Ã— 32
- å­ç»„åç§»ï¼šA=0, B=8, C=16, D=24  
- æœ€ç»ˆç¼–å·ï¼šç»„åŸºæ•° + å­ç»„åç§» + å¼•è„šå·

ä¾‹å¦‚GPIO4_C0_dï¼š
4 Ã— 32 + 16 + 0 = 144
```

**å®é™…vsæ–‡æ¡£å¯¹æ¯”**ï¼š
| å¼•è„š | æ–‡æ¡£è¦æ±‚ | ä»£ç å®ç° | GPIOç¼–å· | è¯´æ˜ |
|------|----------|----------|----------|------|
| A21  | HIGH     | âŒæœªå®ç°  | GPIO16   | éœ€è¦æ‹‰é«˜ä½¿èƒ½FPGAå‡çº§ |
| U3   | LOW      | âŒè®¾ä¸ºHIGH | GPIO144  | åº”è¯¥æ‹‰ä½è¿›å…¥å‡çº§æ¨¡å¼ |
| AF2  | LOW      | âŒæœªå®ç°  | GPIO106  | éœ€è¦æ‹‰ä½é…åˆå‡çº§ |

## 9. RK3568ç³»ç»Ÿå‡çº§

### 9.1 ç³»ç»Ÿå‡çº§è„šæœ¬

```qml
function upgraderk3568(){
    webSocketServer.sendMessageToAllClients("UPGRADELOG||start upgrade web...\r\n");
    
    // æ¨¡æ‹Ÿè¿›åº¦æ˜¾ç¤º  è¿™ä¸ªå‡çº§è¿›åº¦æ˜¯æ¨¡æ‹Ÿçš„ï¼Ÿ
    webSocketServer.sendMessageToAllClients("PROGRESSVALUE||10.00\r\n");
    webSocketServer.sendMessageToAllClients("PROGRESSVALUE||40.00\r\n");
    webSocketServer.sendMessageToAllClients("PROGRESSVALUE||60.00\r\n");
    webSocketServer.sendMessageToAllClients("PROGRESSVALUE||80.00\r\n");
    webSocketServer.sendMessageToAllClients("PROGRESSVALUE||100.00\r\n");
    webSocketServer.sendMessageToAllClients("UPGRADELOG||web upgrade success.\r\n");
    
    // æ‰§è¡Œç³»ç»Ÿå‡çº§è„šæœ¬
    terminalManager.executeDetachedCommand("/userdata/update.sh");
}
```

**å…³äº/userdata/update.shè„šæœ¬**ï¼š
- è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿçº§å‡çº§è„šæœ¬ï¼Œéœ€è¦åœ¨å®é™…ç¡¬ä»¶æ¿å­ä¸ŠæŸ¥çœ‹
- è„šæœ¬å¯èƒ½åŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼š
  1. ç³»ç»Ÿæ–‡ä»¶æ›´æ–°ï¼ˆä»sg.zipæˆ–www.zipï¼‰
  2. å†…æ ¸æ¨¡å—æ›´æ–°
  3. Webåº”ç”¨æ›´æ–°
  4. ç³»ç»Ÿé‡å¯
- `executeDetachedCommand`: åå°æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»ç¨‹åº

```shell
#!/bin/sh

#mkdir /tmp/update || exit 1
# è§£å‹æ›´æ–°åŒ…
#unzip -o /tmp/update/update.zip -d /tmp/update || exit 1

# æ¸…ç†å¹¶é‡å»ºwwwç›®å½•
rm -rf /userdata/www && \
mkdir /userdata/www && \
unzip -o /tmp/update/www.zip -d /userdata/www || exit 1

# åœæ­¢æ—§ç¨‹åº
killall -9 SG01H-48G-V04 || echo "No process to kill"
sleep 1

# å¤åˆ¶æ–°ç¨‹åº
# cp -r /userdata/update/SG01H-48G-V04 /userdata/SG01H-48G-V04 || exit 1
unzip -o /tmp/update/sg.zip -d /userdata &&\
chmod +x /userdata/SG01H-48G-V04|| exit 1

# é‡å¯è®¾å¤‡
reboot

```

## 10. SPIçƒ§å½•å·¥å…·åˆ†æ

### 10.1 spi.zipåŠŸèƒ½åˆ¤æ–­

```cpp
// websocketserver.cppä¸­çš„å¤„ç†
m_terminalManager.executeCommand("rm -rf /userdata/spi");        // åˆ é™¤æ—§å·¥å…·
m_terminalManager.executeCommand("mv /tmp/update/spi /userdata/spi");  // ç§»åŠ¨æ–°å·¥å…·
m_terminalManager.executeCommand("chmod +x /userdata/spi");      // è®¾ç½®å¯æ‰§è¡Œæƒé™
```

**spi.zipåŒ…å«çš„æ˜¯SPIçƒ§å½•å·¥å…·**ï¼Œç”¨äºï¼š
1. **FPGAå›ºä»¶çƒ§å½•**: é€šè¿‡SPIæ¥å£å‘FPGAçš„Flashå­˜å‚¨å™¨å†™å…¥å›ºä»¶
2. **å‘½ä»¤æ ¼å¼**: `/userdata/spi -w -f /data/top.bin -a 0000`
   - `-w`: å†™å…¥æ¨¡å¼ï¼ˆä¸è¯»å–æ¨¡å¼-rç›¸å¯¹ï¼‰
   - `-f`: æŒ‡å®šå›ºä»¶æ–‡ä»¶è·¯å¾„
   - `-a 0000`: èµ·å§‹åœ°å€ï¼Œä»Flashçš„0x0000åœ°å€å¼€å§‹å†™å…¥
3. **ä¸ºä»€ä¹ˆéœ€è¦æ›´æ–°**: ä¸åŒæ‰¹æ¬¡çš„ç¡¬ä»¶å¯èƒ½éœ€è¦ä¸åŒç‰ˆæœ¬çš„SPIå·¥å…·

```
root@rk3568-buildroot:/data# strings spi | head -n 20
/lib/ld-linux-aarch64.so.1
libstdc++.so.6
__gmon_start__
_ITM_deregisterTMCloneTable
_ITM_registerTMCloneTable
libm.so.6
libgcc_s.so.1
libc.so.6
fopen
perror
ftell
puts
putchar
abort
strtol
memset
fseek
fclose
optarg
stderr
root@rk3568-buildroot:/data# 
```

ä½ è¿è¡Œ `strings spi | head -n 20` çš„ç»“æœéå¸¸æ¸…æ¥šåœ°è¡¨æ˜ï¼š**`spi` æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ ARM64 æ¶æ„ ELF åŠ¨æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶**ï¼Œå¹¶ä¸”æ˜¯ç”¨ **C++ ç¼–å†™çš„**ï¼ˆå› ä¸ºå®ƒä¾èµ– `libstdc++.so.6`ï¼‰ã€‚

---

### âœ… åˆ†æç»“æœè¯´æ˜å¦‚ä¸‹ï¼š

#### ğŸ¯ 1. è¿™æ˜¯ä¸€ä¸ª ELF å¯æ‰§è¡Œç¨‹åº

ç¬¬ä¸€è¡Œå°±æš´éœ²äº†è¿è¡Œæ—¶é“¾æ¥å™¨ï¼š

```
/lib/ld-linux-aarch64.so.1
```

â†’ è¡¨æ˜è¿™æ˜¯ä¸€ä¸ª aarch64ï¼ˆARM64ï¼‰å¹³å°çš„ **åŠ¨æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶**ï¼ˆä¸æ˜¯ shell è„šæœ¬ã€ä¹Ÿä¸æ˜¯æ•°æ®æ–‡ä»¶ï¼‰ã€‚

---

#### ğŸ§  2. ä¾èµ–åº“è¯´æ˜å®ƒæ˜¯ C/C++ ç¨‹åº

| å­—ç¬¦ä¸²              | å«ä¹‰                           |
| ---------------- | ---------------------------- |
| `libstdc++.so.6` | ä½¿ç”¨äº† C++ æ ‡å‡†åº“                  |
| `libc.so.6`      | åŸºæœ¬çš„ C å‡½æ•°åº“ï¼ˆå¦‚ `fopen`, `puts`ï¼‰ |
| `libm.so.6`      | æ•°å­¦åº“ï¼ˆå¦‚ `sin`, `sqrt`ï¼‰         |
| `libgcc_s.so.1`  | GCC è¿è¡Œæ”¯æŒåº“                    |

è¿™äº›éƒ½è¯´æ˜å®ƒæ˜¯ä¸€ä¸ªç”¨ **GCC å·¥å…·é“¾ï¼ˆarm64ï¼‰ç¼–è¯‘å‡ºæ¥çš„ C++ å¯æ‰§è¡Œç¨‹åº**ã€‚

---

#### ğŸ“‚ 3. å‡½æ•°è¯´æ˜å®ƒå¯èƒ½æœ‰æ–‡ä»¶æ“ä½œåŠŸèƒ½

è¿™äº›å‡½æ•°å¸¸ç”¨äºæ–‡ä»¶æ“ä½œï¼Œå’Œä½ è¯´çš„ SPI çƒ§å½•å‡çº§åŠŸèƒ½å¯èƒ½æœ‰å…³ï¼š

| å‡½æ•°       | ä½œç”¨                            |
| -------- | ----------------------------- |
| `fopen`  | æ‰“å¼€æ–‡ä»¶                          |
| `ftell`  | è·å–æ–‡ä»¶å¤§å°                        |
| `fseek`  | æ–‡ä»¶å®šä½                          |
| `fclose` | å…³é—­æ–‡ä»¶                          |
| `abort`  | å¼‚å¸¸é€€å‡º                          |
| `strtol` | å­—ç¬¦ä¸²è½¬æ•´æ•°ï¼ˆå¤„ç†å‚æ•°ï¼‰                  |
| `optarg` | å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼ˆå¦‚ `-f /data/top.bin`ï¼‰ |

---

### ğŸ” åˆæ­¥åŠŸèƒ½æ¨æµ‹ï¼šçƒ§å½•å·¥å…·

ç»“åˆä½ ä¹‹å‰æåˆ°çš„ä½¿ç”¨å‘½ä»¤ï¼š

```bash
/userdata/spi -w -f /data/top.bin -a 0000
```

å†ç»“åˆè¿™é‡Œçœ‹åˆ°çš„å‡½æ•°å’Œåº“ä¾èµ–ï¼Œå¯ä»¥æ¨æµ‹ï¼š

> è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„çƒ§å½•ç¨‹åºï¼Œ**é€šè¿‡ SPI æ¥å£**å°† `/data/top.bin` å†™å…¥æŸä¸ªèŠ¯ç‰‡ï¼ˆå¦‚ FPGA æˆ– MCUï¼‰ã€‚

å®ƒå¤„ç†ï¼š

* å‘½ä»¤è¡Œå‚æ•°ï¼ˆ`-w`ã€`-f`ã€`-a`ï¼‰
* æ–‡ä»¶è¯»å–ï¼ˆè¯»å– `top.bin` å›ºä»¶ï¼‰
* ä¸²å£/SPI è®¾å¤‡äº¤äº’ï¼ˆå…·ä½“å‡½æ•°ä¸åœ¨ `strings` å‰ 20 è¡Œä¸­ï¼Œéœ€è¦æ›´æ·±å…¥åç¼–è¯‘æ‰èƒ½ç¡®è®¤ï¼‰

---

### ğŸ§° å¦‚æœä½ æƒ³è¿›ä¸€æ­¥ï¼š

| ç›®æ ‡                              | æ“ä½œ                                     |               |
| ------------------------------- | -------------------------------------- | ------------- |
| æŸ¥çœ‹å®Œæ•´å­—ç¬¦ä¸²                         | \`strings spi                          | less\`        |
| æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æŸäº›è®¾å¤‡èŠ‚ç‚¹ï¼ˆå¦‚ `/dev/spidev*`ï¼‰ | \`strings spi                          | grep /dev\`   |
| æŸ¥çœ‹æ˜¯å¦æ‰“å°æ—¥å¿—                        | \`strings spi                          | grep -i log\` |
| åç¼–è¯‘åˆ†æå‡½æ•°é€»è¾‘                       | ç”¨ `Ghidra` / `IDA Free` / `objdump` åˆ†æ |               |

---

### âœ… æ€»ç»“

* âœ… ä½ ç¡®è®¤äº† `spi` æ˜¯ ARM64 ELF å¯æ‰§è¡Œæ–‡ä»¶
* âœ… ç”¨ C++ ç¼–å†™ï¼Œå¤„ç†æ–‡ä»¶å’Œå‚æ•°
* âœ… é«˜åº¦å¯èƒ½æ˜¯ä½ ç³»ç»Ÿä¸­ç”¨äº **FPGA æˆ– MCU çƒ§å½•çš„ SPI å·¥å…·**
* âœ… å¯é…åˆ `update.zip` ä¸­çš„ `top.bin` ç­‰ä½¿ç”¨
* âš ï¸ è¯·å‹¿éšæ„æ›¿æ¢å®ƒï¼Œå¦åˆ™ä¼šç ´åçƒ§å½•æµç¨‹

---

å¦‚æœä½ å¸Œæœ›æˆ‘å¸®ä½ ï¼š

* åˆ†æ `spi` å·¥å…·çš„å®Œæ•´å‚æ•°æ”¯æŒ
* ç¼–å†™è„šæœ¬ä¸€é”®è°ƒç”¨å‡çº§æµç¨‹
* åç¼–è¯‘çœ‹çœ‹å®ƒæ˜¯å¦å®‰å…¨æˆ–å¯ä»¥æ›¿æ¢

æ¬¢è¿ç»§ç»­è´´å‡ºå†…å®¹æˆ–éœ€æ±‚ï¼Œæˆ‘å¯ä»¥ä¸€æ­¥æ­¥ååŠ©ä½ æ·±å…¥äº†è§£å’ŒæŒæ§å®ƒã€‚


## 11. å‡çº§å®Œæˆæµç¨‹

### 11.1 å‡çº§é¡ºåºæ§åˆ¶

Webå‰ç«¯é€šè¿‡ç›‘å¬å‡çº§å®Œæˆæ¶ˆæ¯æ¥æ§åˆ¶å‡çº§é¡ºåºï¼š

```javascript
// systemsetting.vue - data_dealå‡½æ•°
if (data_line.indexOf("UPGRADELOG") != -1) {
    var linedata = data_line.split("||");
    
    // MCUå‡çº§å®Œæˆåï¼Œè‡ªåŠ¨å¼€å§‹ä¸‹ä¸€ä¸ªç»„ä»¶
    if(data_line.includes("mcu upgrade success")){
        this.upgrade_mcu = false;
        if(this.upgrade_c51) this.socket.send("upgrade:c51\r\n");
        else if(this.upgrade_fpga) this.socket.send("upgrade:fpga\r\n");
        else if(this.upgrade_rk3568) this.socket.send("upgrade:rk3568\r\n");
    }
    
    // C51å‡çº§å®Œæˆå
    if(data_line.includes("c51 upgrade success")){
        this.upgrade_c51 = false;
        if(this.upgrade_fpga) this.socket.send("upgrade:fpga\r\n");
        else if(this.upgrade_rk3568) this.socket.send("upgrade:rk3568\r\n");
    }
    
    // FPGAå‡çº§å®Œæˆå
    if(data_line.includes("FPGA upgrade success")){
        this.upgrade_fpga = false;
        if(this.upgrade_rk3568) this.socket.send("upgrade:rk3568\r\n");
    }
    
    // æ‰€æœ‰å‡çº§å®Œæˆ
    if(data_line.includes("web upgrade success")){
        this.upgrade_rk3568 = false;
        // å‡çº§æµç¨‹ç»“æŸ
    }
}
```

## 12. è¿›åº¦ç›‘æ§æœºåˆ¶

### 12.1 FPGAå‡çº§è¿›åº¦

```qml
TerminalManager {
    id: terminalManager
    onCommandOutputChanged:{
        // ç›‘å¬ç»ˆç«¯å‘½ä»¤è¾“å‡ºï¼Œæ•è·FPGAçƒ§å½•è¿›åº¦
        if(output.indexOf("fpga process")!=-1){
            var tmpprocess = output.split(" ");
            // æå–è¿›åº¦ç™¾åˆ†æ¯”å¹¶å‘é€ç»™å‰ç«¯
            webSocketServer.sendMessageToAllClients("PROGRESSVALUE||"+ tmpprocess[2] +"\r\n");
            if(parseInt(tmpprocess[2],10)===100){
                webSocketServer.sendMessageToAllClients("UPGRADELOG||FPGA upgrade success\r\n");
            }
        }
    }
}
```

### 12.2 Webå‰ç«¯è¿›åº¦æ˜¾ç¤º

```javascript
// systemsetting.vue - data_dealå‡½æ•°
data_deal(data_line) {
    // å¤„ç†è¿›åº¦æ›´æ–°
    if (data_line.indexOf("PROGRESSVALUE") != -1) {
        var linedata = data_line.split("||");
        this.knowledge = linedata[1]; // æ›´æ–°è¿›åº¦æ¡ (0-100)
    }
    
    // å¤„ç†æ—¥å¿—æ›´æ–°
    if (data_line.indexOf("UPGRADELOG") != -1) {
        var linedata = data_line.split("||");
        for (var a in linedata) {
            if (a != 0) {
                this.log_data += linedata[a] + "\n"; // æ·»åŠ åˆ°æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ
            }
        }
    }
}
```

## 13. é”™è¯¯å¤„ç†ä¸é‡è¿æœºåˆ¶

### 13.1 WebSocketé‡è¿

```javascript
this.socket.onclose = function (event) {
    console.log("uploadpath connection closed");
    setTimeout(() => {
        self.ws_upload_open();  // 1ç§’åè‡ªåŠ¨é‡è¿
    }, 1000);
};
```

### 13.2 å‡çº§å¤±è´¥å¤„ç†

- è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼šWebSocketæ–­çº¿é‡è¿
- è¯¦ç»†é”™è¯¯æ—¥å¿—ï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰æ—¥å¿—è®°å½•
- ç”¨æˆ·æ‰‹åŠ¨é‡å¯ï¼šæä¾›é‡å¯æŒ‰é’®

## 14. å®‰å…¨è€ƒè™‘

1. **æƒé™æ§åˆ¶**: å‡çº§æ“ä½œéœ€è¦rootæƒé™
2. **æ–‡ä»¶éªŒè¯**: éªŒè¯å‡çº§åŒ…æ ¼å¼å’Œå®Œæ•´æ€§
3. **å›æ»šæœºåˆ¶**: å‡çº§å¤±è´¥æ—¶çš„æ¢å¤æ–¹æ¡ˆ
4. **GPIOå®‰å…¨**: GPIOæ“ä½œå¤±è´¥æ—¶çš„å®‰å…¨å¤„ç†

## 15. ä½¿ç”¨ç¤ºä¾‹

### 15.1 å®Œæ•´å‡çº§æµç¨‹

1. **å‡†å¤‡å‡çº§åŒ…**:
```
update.zip
â”œâ”€â”€ mcu.zip (åŒ…å«FW.fwm)
â”œâ”€â”€ c51.zip (åŒ…å«c51.hex)
â”œâ”€â”€ fpga.zip (åŒ…å«top.bin)
â”œâ”€â”€ sg.zip (ç³»ç»Ÿæ–‡ä»¶)
â””â”€â”€ spi.zip (SPIå·¥å…·)
```

2. **Webç•Œé¢æ“ä½œ**:
   - æ‰“å¼€SystemSettingé¡µé¢
   - ç‚¹å‡»"UPDATE FIRMWARE"
   - é€‰æ‹©update.zipæ–‡ä»¶
   - ç‚¹å‡»"Upload"ä¸Šä¼ 
   - é€‰æ‹©è¦å‡çº§çš„ç»„ä»¶
   - ç‚¹å‡»"Upgrade"å¼€å§‹å‡çº§

3. **å‡çº§é¡ºåº**: MCU â†’ C51 â†’ FPGA â†’ RK3568

## 16. æ”¹è¿›å»ºè®®

### 16.1 FPGAå‡çº§GPIOæ§åˆ¶ä¿®æ­£

æ ¹æ®æ–‡æ¡£è¦æ±‚ï¼ŒFPGAå‡çº§æ—¶åº”è¯¥ï¼š

```qml
function upgradefpga(){
    // æ­£ç¡®çš„GPIOæ§åˆ¶
    terminalManager.executeCommand("echo 16 > /sys/class/gpio/export");   // A21
    terminalManager.executeCommand("echo out > /sys/class/gpio/gpio16/direction");
    terminalManager.executeCommand("echo 1 > /sys/class/gpio/gpio16/value"); // HIGH
    
    terminalManager.executeCommand("echo 144 > /sys/class/gpio/export");  // U3  
    terminalManager.executeCommand("echo out > /sys/class/gpio/gpio144/direction");
    terminalManager.executeCommand("echo 0 > /sys/class/gpio/gpio144/value"); // LOW
    
    terminalManager.executeCommand("echo 106 > /sys/class/gpio/export");  // AF2
    terminalManager.executeCommand("echo out > /sys/class/gpio/gpio106/direction");
    terminalManager.executeCommand("echo 0 > /sys/class/gpio/gpio106/value"); // LOW
    
    // å›ºä»¶å‡çº§...
}
```

### 16.2 å‡çº§å®ŒæˆåGPIOæ¢å¤

```qml
function exitFpgaUpgradeMode(){
    terminalManager.executeCommand("echo 0 > /sys/class/gpio/gpio16/value"); // A21 LOW
    terminalManager.executeCommand("echo 1 > /sys/class/gpio/gpio144/value"); // U3 HIGH
    terminalManager.executeCommand("echo 1 > /sys/class/gpio/gpio106/value"); // AF2 HIGH-Z
}
```

## 17. æ€»ç»“

sa01h-48g-v04-webå‡çº§åŠŸèƒ½é‡‡ç”¨äº†æ¨¡å—åŒ–è®¾è®¡ï¼Œé€šè¿‡WebSocketå®ç°Webå‰ç«¯ä¸Qtåå°çš„å®æ—¶é€šä¿¡ã€‚ç³»ç»Ÿæ”¯æŒå¤šç»„ä»¶é¡ºåºå‡çº§ï¼Œå…·æœ‰å®Œå–„çš„è¿›åº¦ç›‘æ§å’Œé”™è¯¯å¤„ç†æœºåˆ¶ã€‚ä¸»è¦ç‰¹ç‚¹ï¼š

1. **åˆ†å±‚æ¶æ„**: Webå‰ç«¯è´Ÿè´£ç”¨æˆ·ç•Œé¢ï¼ŒQtåå°è´Ÿè´£ç¡¬ä»¶æ§åˆ¶
2. **å®æ—¶é€šä¿¡**: WebSocketåŒå‘é€šä¿¡ï¼Œæ”¯æŒæ–‡ä»¶ä¸Šä¼ å’ŒçŠ¶æ€åŒæ­¥
3. **åˆ†ç‰‡ä¸Šä¼ **: å¤§æ–‡ä»¶åˆ†ç‰‡ä¼ è¾“ï¼Œæé«˜ç¨³å®šæ€§
4. **è‡ªåŠ¨åŒ–æµç¨‹**: æ–‡ä»¶è§£å‹ã€ç»„ä»¶å‡çº§ã€è¿›åº¦ç›‘æ§å…¨è‡ªåŠ¨
5. **ç¡¬ä»¶æ§åˆ¶**: GPIOæ§åˆ¶ã€ä¸²å£é€šä¿¡ã€SPIçƒ§å½•ç­‰åº•å±‚æ“ä½œ

FPGAå‡çº§æ—¶è™½ç„¶å®ç°äº†åŸºæœ¬çš„GPIOæ§åˆ¶ï¼Œä½†ä¸æ–‡æ¡£è¦æ±‚è¿˜æœ‰å·®å¼‚ï¼Œéœ€è¦è¿›ä¸€æ­¥å®Œå–„GPIOæ§åˆ¶é€»è¾‘ä»¥ç¡®ä¿å‡çº§è¿‡ç¨‹çš„å¯é æ€§ã€‚ 