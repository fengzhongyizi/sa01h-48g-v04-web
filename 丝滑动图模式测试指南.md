# SA01H-48G-V04 丝滑动图模式测试指南

## 功能概述

为了解决滚动ColorBar等动态图像显示不流畅的问题，新增了**丝滑动图模式**，将帧率从2fps提升到15fps，实现更流畅的动图显示。

## 技术方案

### 🎯 **优化策略**
- **帧率提升**：从500ms一次（2fps）→ 67ms一次（15fps），提升7.5倍
- **性能平衡**：选择15fps而非30fps，节省一半性能开销
- **双缓冲技术**：A/B两个缓冲区交替使用，避免数据冲突
- **交替策略**：采集-显示-采集-显示，分散CPU负载

### 🛠 **核心实现**
```cpp
// 关键参数
帧间隔：67ms (≈15fps)
缓冲区：双缓冲 6.2MB × 2
超时：30ms防卡死
策略：交替采集显示
```

## 使用方法

### 📱 **界面操作**
1. 进入Monitor页面
2. 在底部信息区域找到控制按钮：
   - **"Smooth OFF"** 橙色按钮：点击启动丝滑模式
   - **"Smooth ON"** 绿色按钮：点击停止丝滑模式
   - **帧率显示**：显示当前模式的帧率（2fps/15fps）

### 🔧 **API调用**
```cpp
// C++ 接口
signalAnalyzerManager.startSmoothVideoMode();   // 启动
signalAnalyzerManager.stopSmoothVideoMode();    // 停止
signalAnalyzerManager.isSmoothVideoMode();      // 查询状态

// QML 调用
signalAnalyzerManager.startSmoothVideoMode()
```

## 测试步骤

### 🧪 **滚动ColorBar测试**
1. **准备信号源**：
   - 设置输入信号为滚动的ColorBar
   - 确保PRBS等测试信号已切换到正常视频

2. **对比测试**：
   - **普通模式**：观察滚动ColorBar的跳跃、断帧情况
   - **丝滑模式**：点击"Smooth OFF"启动，观察流畅度改善

3. **性能观察**：
   - 监控CPU使用率
   - 观察内存使用情况
   - 检查是否有掉帧或卡顿

### 📊 **性能基准测试**
```bash
# 监控系统资源
top -p $(pgrep SA01H)   # CPU使用率
free -h                 # 内存使用
iotop                   # IO性能
```

### 🎯 **预期效果**
| 测试项目 | 普通模式(2fps) | 丝滑模式(15fps) |
|---------|---------------|-----------------|
| 滚动连续性 | ❌ 跳跃断续 | ✅ 基本连续 |
| 视觉流畅度 | ❌ 明显卡顿 | ✅ 明显改善 |
| CPU使用率 | 低 | 中等 |
| 内存占用 | 低 | 稍高(+12MB) |

## 性能调优

### 🔧 **帧率调整**
如果15fps对板子压力太大，可以调整：
```cpp
// 在 startHighFrameRateCapture() 中修改
int frameInterval = 100; // 100ms = 10fps
// int frameInterval = 67;  // 67ms = 15fps  
// int frameInterval = 50;  // 50ms = 20fps
```

### ⚡ **进一步优化建议**
1. **降低分辨率测试**：改为720p测试性能极限
2. **内存优化**：使用mmap直接访问DMA而非文件IO
3. **硬件加速**：如果有GPU，考虑OpenGL渲染
4. **帧跳过策略**：高负载时自动跳帧

## 故障排除

### ❌ **常见问题**
1. **启动后无反应**：
   - 检查DMA设备权限
   - 查看调试日志确认定时器启动

2. **帧率不达标**：
   - 监控`dma_from_device`命令执行时间
   - 调整超时时间或帧间隔

3. **内存泄漏**：
   - 检查QProcess是否正确释放
   - 监控缓冲区大小变化

### 🐛 **调试信息**
启用调试输出查看详细信息：
```bash
# 查看应用日志
journalctl -f | grep SA01H
```

## RK3568板子性能评估

### 📈 **理论分析**
- **数据量**：6.2MB/frame × 15fps = 93MB/s
- **RK3568内存带宽**：~3GB/s (足够)
- **PCIe带宽**：Gen2 x1 = 500MB/s (足够)
- **瓶颈**：主要在用户态进程切换和Qt渲染

### 🎯 **预期结果**
- ✅ **10-15fps**：应该能稳定支持
- ⚠️ **20-30fps**：可能需要进一步优化
- ❌ **60fps**：当前方案不建议尝试

## 下一步优化方向

如果15fps效果良好，可以考虑：
1. **提高到20fps**：进一步提升流畅度
2. **自适应帧率**：根据系统负载动态调整
3. **mmap优化**：绕过文件系统直接内存操作
4. **多线程采集**：采集和显示完全并行

---

**测试建议**：先在滚动ColorBar上测试基本效果，确认可行后再考虑更高的帧率优化。 