# FPGA通信指令文档

## 概述

本文档描述了信号分析器应用程序与FPGA之间的通信协议。FPGA负责处理HDMI信号分析、视频捕获和错误率监控功能。

## 硬件连接

### 串口通信
- **接口**: UART3 (/dev/ttyS3)
- **波特率**: 115200
- **数据位**: 8
- **奇偶校验**: 无 (N)
- **停止位**: 1

### PCIe通信
- **接口**: PCIe总线 (/dev/pcie_video0)
- **用途**: 高速视频数据传输
- **格式**: 原始视频帧数据

## 命令协议

### 1. 命令格式 (发送到FPGA)

所有发送到FPGA的命令都使用以下二进制格式：

```
AA 00 00 <长度> 00 00 00 <命令码> <参数> <校验和>
```

**字段说明:**
- `AA 00 00`: 命令包头标识
- `<长度>`: 数据部分长度 (1字节)
- `00 00 00`: 组地址和设备地址 (固定为0)
- `<命令码>`: 具体命令标识 (1字节)
- `<参数>`: 命令参数 (1字节)
- `<校验和>`: CRC校验 (1字节，自动计算)

### 2. 响应格式 (从FPGA接收)

FPGA返回的数据包使用以下格式：

#### 2.1 命令响应包
```
AB 00 00 <长度> <响应数据> <校验和>
```

#### 2.2 信号信息响应包
```
AB 00 02 <长度> <信息类型> <状态> <数据内容>
```

#### 2.3 图像数据包
```
AB 00 01 <长度字段4字节> <图像数据>
```

#### 2.4 错误率监控数据包
```
AB 00 03 <长度> <时间槽ID 2字节> <槽位ID 1字节> <状态数据>
```

## 功能模块详细说明

### 1. Monitor页面 - 视频显示

#### 1.1 获取视频帧
**命令**: `AA 00 00 06 00 00 00 B1 00`
**功能**: 请求FPGA发送当前视频帧数据
**响应**: AB 00 01 类型的图像数据包

#### 1.2 图像数据传输
- **小包模式**: 通过UART3传输，适用于预览
- **PCIe模式**: 通过PCIe总线传输，适用于高质量实时显示

### 2. Signal Info页面 - 信号参数获取

应用程序需要获取15个信号参数，对应15个不同的命令：

#### 2.1 视频信息命令 (8个)

| 参数 | 命令 | 响应类型 | 说明 |
|------|------|----------|------|
| VIDEO_FORMAT | `AA 00 00 06 00 00 00 61 80` | AB 00 02 | 获取视频格式/分辨率 |
| COLOR_SPACE | `AA 00 00 06 00 00 00 63 80` | AB 00 02 | 获取色彩空间(RGB/YUV) |
| COLOR_DEPTH | `AA 00 00 06 00 00 00 64 80` | AB 00 02 | 获取色彩深度(8/10/12-bit) |
| HDR_FORMAT | `AA 00 00 06 00 00 00 69 80` | AB 00 02 | 获取HDR格式(HDR10/DV等) |
| HDMI_DVI | `AA 00 00 06 00 00 00 66 80` | AB 00 02 | 获取HDMI/DVI模式 |
| FRL_RATE | `AA 00 00 06 00 00 00 70 80` | AB 00 02 | 获取FRL速率 |
| DSC_MODE | `AA 00 00 06 00 00 00 71 80` | AB 00 02 | 获取DSC压缩模式 |
| HDCP_TYPE | `AA 00 00 06 00 00 00 65 80` | AB 00 02 | 获取HDCP版本 |

#### 2.2 音频信息命令 (7个)

| 参数 | 命令 | 响应类型 | 说明 |
|------|------|----------|------|
| SAMPLING_FREQ | `AA 00 00 06 00 00 00 67 80` | AB 00 02 | 获取PCM采样频率 |
| SAMPLING_SIZE | `AA 00 00 06 00 00 00 68 80` | AB 00 02 | 获取PCM位深度 |
| CHANNEL_COUNT | `AA 00 00 06 00 00 00 6A 80` | AB 00 02 | 获取音频通道数 |
| CHANNEL_NUMBER | `AA 00 00 06 00 00 00 6B 80` | AB 00 02 | 获取通道编号映射 |
| LEVEL_SHIFT | `AA 00 00 06 00 00 00 6C 80` | AB 00 02 | 获取音频电平偏移 |
| CBIT_SAMPLING_FREQ | `AA 00 00 06 00 00 00 6E 80` | AB 00 02 | 获取C-bit采样频率 |
| CBIT_DATA_TYPE | `AA 00 00 06 00 00 00 6F 80` | AB 00 02 | 获取C-bit数据类型 |

#### 2.3 信号信息响应数据格式

响应包格式：`AB 00 02 <长度> <信息类型> <状态> <数据内容>`

**信息类型字段对应**:
- 0x61: VIDEO_FORMAT
- 0x63: COLOR_SPACE  
- 0x64: COLOR_DEPTH
- 0x65: HDCP_TYPE
- 0x66: HDMI_DVI
- 0x67: SAMPLING_FREQ
- 0x68: SAMPLING_SIZE
- 0x69: HDR_FORMAT
- 0x6A: CHANNEL_COUNT
- 0x6B: CHANNEL_NUMBER
- 0x6C: LEVEL_SHIFT
- 0x6E: CBIT_SAMPLING_FREQ
- 0x6F: CBIT_DATA_TYPE
- 0x70: FRL_RATE
- 0x71: DSC_MODE

### 3. Error Rate页面 - 错误率监控

#### 3.1 监控控制命令

**开始监控**: `AA 00 00 08 00 00 00 C0 <间隔> <单位> <模式>`
- 间隔: 时间槽间隔(1-255)
- 单位: 0=秒, 1=分钟  
- 模式: 0=图像差异+信号丢失, 1=仅信号丢失

**停止监控**: `AA 00 00 06 00 00 00 C1 00`

**清除数据**: `AA 00 00 06 00 00 00 C2 00`

#### 3.2 监控数据接收格式

**数据包格式**: `AB 00 03 <长度> <时间槽ID 2字节> <槽位ID 1字节> <状态数据>`

**详细说明**:
- **时间槽ID**: 2字节，范围0001-2040，表示第几个时间槽
- **槽位ID**: 1字节，0-99，表示当前数据包对应的槽位编号
- **状态数据**: 1字节，槽位状态(0=正常, 1-255=各种异常类型)

**优势**:
- **按需发送**: 仅在检测到异常时发送数据包，减少通信开销
- **实时性好**: 异常发生即刻上报，无需等待整个时间槽完成
- **灵活扩展**: 状态数据可以表示不同类型的异常

**示例**:
```
发送: AA 00 00 08 00 00 00 C0 05 00 01  # 开始监控，5秒间隔，仅信号丢失模式
接收: AB 00 03 04 00 01 05 01 # 时间槽0001，槽位05，检测到异常(类型1)
接收: AB 00 03 04 00 01 23 01 # 时间槽0001，槽位23，检测到异常(类型1)  
接收: AB 00 03 04 00 01 67 02 # 时间槽0001，槽位67，检测到异常(类型2)
```

**数据解析**:
- 时间槽0001中，槽位05、23、67出现异常
- 其他槽位(0-4, 6-22, 24-66, 68-99)均正常
- 异常类型1可能表示信号丢失，类型2可能表示图像差异

**FPGA实现建议**:
FPGA端可以采用以下策略：
1. **实时检测**: 在每个槽位时间内连续监控信号状态
2. **异常上报**: 一旦检测到异常立即发送数据包
3. **状态缓存**: 可选择缓存一定数量的异常事件后批量发送
4. **槽位管理**: FPGA内部维护当前时间槽和槽位计数器

**FPGA无需关心的事项**:
- **完整状态管理**: 无需跟踪所有100个槽位的完整状态
- **正常状态上报**: 无需发送状态=0的数据包
- **状态聚合**: 应用层会自动处理槽位状态的聚合和显示
- **UI更新逻辑**: FPGA只需专注于异常检测和上报

**工作流程**:
```
应用层发送开始监控命令 → FPGA开始监控
FPGA检测到异常 → 立即发送异常数据包
应用层接收数据包 → 更新对应槽位状态 → 刷新UI显示
```

### 4. EDID页面 - EDID管理

**获取EDID列表**: 通过MCU (UART5)
**应用EDID**: `SET IN1 EDID<索引>\r\n` (ASCII命令到MCU)

## PCIe视频传输

### 设备路径
- 主设备: `/dev/pcie_video0`
- 备用设备: `/dev/pcie_video1`

### 支持格式
- 分辨率: 1920x1080, 3840x2160
- 帧率: 30Hz, 60Hz
- 色彩格式: RGB24, YUV420, YUV422

### 传输模式
1. **实时流**: 连续传输视频帧
2. **单帧捕获**: 按需捕获单个帧
3. **缓冲模式**: 使用环形缓冲区

## 错误处理

### 通信错误
- 超时: 1000ms无响应视为超时
- 重试: 最多重试3次
- 降级: PCIe失败时切换到UART

### 数据校验
- CRC校验: 所有命令包含校验和
- 长度校验: 验证数据包长度
- 格式校验: 验证包头格式

## 性能优化

### 减少延迟
- 批量发送命令时间间隔: 50ms
- 图像数据优先级: 高
- 监控数据优先级: 中等

### 带宽管理
- UART3带宽: 115200 bps
- PCIe带宽: 高速（具体速率待确认）
- 数据压缩: 支持JPEG压缩

## 数据包示例

### 1. 获取视频格式
```bash
发送: AA 00 00 06 00 00 00 61 80 <校验和>
接收: AB 00 02 06 61 80 07 80 04 38  # 1920x1080
解析: 宽度=1920(0x0780), 高度=1080(0x0438)
结果: SIGNAL_INFO VIDEO_FORMAT 1920x1080
```

### 2. 开始错误监控
```bash
发送: AA 00 00 08 00 00 00 C0 00 05 00 00 <校验和>
参数: 间隔=5秒, 单位=秒, 模式=图像差异+信号丢失
接收: AB 00 03 <长度> <监控数据...>
```

### 3. 监控数据包
```bash
接收: AB 00 03 15 00 01 FF 00 FF 00 ... # 时间槽1的状态数据
解析: 时间槽ID=0001, 状态数据=FF00FF00... (二进制)
转换: SIGNAL_SLOT 0001 1111111100000000111111110000000...
```

## 调试信息

### 1. 调试日志
所有通信过程都有详细的qDebug()输出：
- 命令发送记录
- 数据包接收分析
- 解析结果显示
- 错误信息记录

### 2. 关键日志标识
- `=== FPGA Data Analysis ===`: 数据包分析
- `*** SIGNAL INFO PACKET DETECTED ***`: 信号信息包
- `*** ERROR RATE MONITOR PACKET DETECTED ***`: 监控数据包
- `=== Starting Error Rate Monitor ===`: 开始监控

## 待确认项目

与FPGA团队需要确认的协议细节：

1. **信号信息响应格式**是否与文档一致
2. **FRL速率和DSC模式**的具体命令码
3. **监控数据包**的确切格式
4. **PCIe设备**的实际路径和格式
5. **图像数据包**的长度字段编码方式
6. **错误检测算法**的具体实现细节

请根据实际FPGA固件实现调整相应的命令码和数据格式。 